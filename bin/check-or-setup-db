#!/usr/bin/env ruby
require 'rubygems'
require 'bundler'

Bundler.setup(:default)

require 'active_record'

exit begin
  connection_tries ||= 3
  ActiveRecord::Base.establish_connection && ActiveRecord::Migrator.current_version
  0
rescue PG::ConnectionBad => e
  unless (connection_tries -= 1).zero?
    puts "Retrying DB connection #{connection_tries} more times..."
    sleep ENV.fetch('APP_SETUP_WAIT', '5').to_i
    retry
  end
  1
rescue ActiveRecord::NoDatabaseError => e
  puts "\n== Preparing database =="
  return 2 unless system "bin/rake db:setup"
  0
ensure
  ActiveRecord::Base.clear_all_connections!
end
